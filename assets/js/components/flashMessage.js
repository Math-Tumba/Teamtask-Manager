const FLASHMESSAGES = $('.flash-messages-container')
const DELAY = 5000;

/**
 * Allows the creation of flash messages asynchronously.
 */
export class FlashMessage {
    static Types = {
        SUCCESS: 'success',
        WARNING: 'warning',
        ERROR: 'danger',
    };

    constructor(message, type = 'success') {
        if (Array.isArray(message)) {
            this.message = message[0].message;
        } else {
            this.message = message;
        }
        this.type = type;
        this.generateMessage();
    }

    generateMessage() {
        this.element = $(`
            <div class="flash-message alert alert-${this.type} mb-0 p-3"> 
                <p>${this.message}</p>
            </div>
        `);
        FLASHMESSAGES.append(this.element);
        this.element.fadeIn(500);

        this.element.on('click', () => this.removeMessage());

        setTimeout(() => this.removeMessage(), DELAY);
    }

    removeMessage() {
        this.element.fadeOut(500, () => this.element.remove());
    }
}

/**
 * Displays the flash message generated by kyManager.js.
 */
const StoredFlashMessage = localStorage.getItem('flashMessage');
if (StoredFlashMessage) {
    const { message, type } = JSON.parse(StoredFlashMessage);
    new FlashMessage(message, type);
    localStorage.removeItem('flashMessage');
}

/**
 * Displays all flash messages that come from PHP code.
 */
FLASHMESSAGES.children().each(function () {
    const flashText = $(this).text().trim();
    const className = $(this).attr('class');
    const match = className.match(/alert-([\w-]+)/);
    $(this).remove();
    new FlashMessage(flashText, match[1]);
});